version: "3"
services:
  service-discovery-container:
    build:
      context: ./service-discovery
      dockerfile: Dockerfile
    image: toandeptroai/service-discovery:0.1.0
    container_name: service-discovery-container
    ports:
      - 8761:8761
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - do-an-net
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  api-gateway-container:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    image: toandeptroai/api-gateway:0.1.0
    container_name: api-gateway-container
    ports:
      - 8443:8443
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - do-an-net
    depends_on:
      service-discovery-container:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8443/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  proxy-client-container:
    build:
      context: ./proxy-client
      dockerfile: Dockerfile
    image: toandeptroai/proxy-client:0.1.0
    container_name: proxy-client-container
    ports:
      - 8085:8085
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - do-an-net
    depends_on:
      api-gateway-container:
        condition: service_healthy
    restart: always

  user-service-container:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    image: toandeptroai/user-service:0.1.0
    container_name: user-service-container
    ports:
      - 8080:8080
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - do-an-net
    depends_on:
      service-discovery-container:
        condition: service_healthy
    restart: always

  blog-service-container:
    build:
      context: ./blog-service
      dockerfile: Dockerfile
    image: toandeptroai/blog-service:0.1.0
    container_name: blog-service-container
    ports:
      - 8081:8081
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - do-an-net
    depends_on:
      api-gateway-container:
        condition: service_healthy
    restart: always

  course-service-container:
    build:
      context: ./course-service
      dockerfile: Dockerfile
    image: toandeptroai/course-service:0.1.0
    container_name: course-service-container
    ports:
      - 8082:8082
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - do-an-net
    depends_on:
      api-gateway-container:
        condition: service_healthy
    restart: always

  learning-path-service-container:
    build:
      context: ./learning-path-service
      dockerfile: Dockerfile
    image: toandeptroai/learning-path-service:0.1.0
    container_name: learning-path-service-container
    ports:
      - 8083:8083
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - do-an-net
    depends_on:
      api-gateway-container:
        condition: service_healthy
    restart: always

  payment-service-container:
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    image: toandeptroai/payment-service:0.1.0
    container_name: payment-service-container
    ports:
      - 8084:8084
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - do-an-net
    depends_on:
      api-gateway-container:
        condition: service_healthy
    restart: always

  file-service-container:
    build:
      context: ./file-service
      dockerfile: Dockerfile
    image: toandeptroai/file-service:0.1.0
    container_name: file-service-container
    ports:
      - 8086:8086
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - do-an-net
    depends_on:
      service-discovery-container:
        condition: service_healthy
    restart: always

  notification-service-container:
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    image: toandeptroai/notification-service:0.1.0
    container_name: notification-service-container
    ports:
      - 8088:8088
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    networks:
      - do-an-net
    depends_on:
      service-discovery-container:
        condition: service_healthy
    restart: always

networks:
  do-an-net:
    name: do-an-network
    external: true
